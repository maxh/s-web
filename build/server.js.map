{"version":3,"sources":["webpack:///webpack/bootstrap a1655faddc1d65623895","webpack:///./server/index.js","webpack:///external \"body-parser\"","webpack:///external \"express\"","webpack:///external \"cookie-parser\"","webpack:///external \"cookie-session\"","webpack:///external \"morgan\"","webpack:///./server/routes/auth.js","webpack:///external \"googleapis\"","webpack:///./server/infra/google-auth.js","webpack:///./server/settings.js","webpack:///./settings.js","webpack:///./server/infra/net.js","webpack:///external \"isomorphic-fetch\"","webpack:///./server/routes/permissions.js","webpack:///external \"crypto\"","webpack:///external \"query-string\"","webpack:///external \"request\""],"names":["app","use","secret","keys","scoutWebSessionKey","isDev","static","forceHttpsUnlessDev","req","res","next","isHeroku","header","redirect","url","json","listen","port","console","log","googleAuth","OAuth2","auth","REDIRECT_PATH","oauth2Client","google_clientId","google_clientSecret","serverUrl","getTokensFromCode","INITIAL_SCOPES","NO_REFRESH_TOKEN","getJwtPromise","params","scoutServiceUrl","scoutWebServerSecret","options","method","body","JSON","stringify","headers","fetch","then","response","ok","Error","error","jwt","router","Router","get","destination","query","session","generateAuthUrl","access_type","scope","code","tokensPromise","scopesPromise","getTokenInfo","tokens","accessToken","tokenInfo","split","profilePromise","getProfile","promises","Promise","all","jwtPromise","values","scopes","profile","googleId","id","email","emails","value","name","displayName","cookie","clientServerUrl","catch","message","forceRefreshUrl","prompt","resolve","reject","getToken","err","refreshToken","refresh_token","access_token","accessTokenExpiration","expiry_date","INFO_URL","google_apiKey","parse","process","env","AUTH_KEYS","endpoint","fn","wrapper","sendClientError","status","promise","e","result","headersSent","send","fetchJson","setPermission","provider","providerInfo","authorization","redirectPath","cookies","savedState","randomBytes","toString","state","tokenInfoPromise","permissionPromise","dropboxRedirectUri","client_id","dropbox_clientId","redirect_uri","response_type","stringified","destinationUrl","tokenPromise","post","form","grant_type","user","pass","dropbox_clientSecret","reqError","token","accountId","account_id"],"mappings":";;AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,uBAAe;AACf;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;;;;;;;;;;;ACtCA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;AAEA;;;;;;AAGA,KAAMA,MAAM,wBAAZ;;AAEAA,KAAIC,GAAJ,CAAQ,6BAAR;AACAD,KAAIC,GAAJ,CAAQ,6BAAc,EAAEC,QAAQ,mBAASC,IAAT,CAAcC,kBAAxB,EAAd,CAAR;;AAEA,KAAI,CAAC,mBAASC,KAAd,EAAqB;AACnBL,OAAIC,GAAJ,CAAQ,kBAAQK,MAAR,CAAe,cAAf,CAAR;AACD;;AAED,KAAMC,sBAAsB,SAAtBA,mBAAsB,CAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC9C,OAAI,CAAC,mBAASL,KAAV,IAAmB,mBAASM,QAA5B,IACAH,IAAII,MAAJ,CAAW,mBAAX,MAAoC,OADxC,EACiD;AAC/C,YAAOH,IAAII,QAAJ,cAAwBL,IAAII,MAAJ,CAAW,MAAX,CAAxB,GAA6CJ,IAAIM,GAAjD,CAAP;AACD;AACD,UAAOJ,MAAP;AACD,EAND;AAOAV,KAAIC,GAAJ,CAAQM,mBAAR;AACAP,KAAIC,GAAJ,CAAQ,qBAAWc,IAAX,EAAR;AACAf,KAAIC,GAAJ,CAAQ,sBAAO,UAAP,CAAR;;AAEAD,KAAIC,GAAJ,CAAQ,OAAR;AACAD,KAAIC,GAAJ,CAAQ,cAAR;;AAEAD,KAAIgB,MAAJ,CAAW,mBAASC,IAApB,EAA0B,YAAM;AAC9B;AACAC,WAAQC,GAAR,CAAY,uBAAZ,EAAqC,mBAASF,IAA9C;AACD,EAHD,E;;;;;;;;;ACnCA,yC;;;;;;;;;ACAA,qC;;;;;;;;;ACAA,2C;;;;;;;;;ACAA,4C;;;;;;;;;ACAA,oC;;;;;;;;;;;;;;;;;ACAA;;;;AACA;;;;AAEA;;KAAYG,U;;AACZ;;AACA;;;;;;;;AAGA,KAAMC,SAAS,qBAAOC,IAAP,CAAYD,MAA3B;;AAEA,KAAME,gBAAgB,gBAAtB;AACA,KAAMC,eAAe,IAAIH,MAAJ,CACnB,mBAASlB,IAAT,CAAcsB,eADK,EAEnB,mBAAStB,IAAT,CAAcuB,mBAFK,EAGnB,mBAASC,SAAT,GAAqBJ,aAHF,CAArB;AAKA,KAAMK,oBAAoBR,WAAWQ,iBAAX,CAA6BJ,YAA7B,CAA1B;;AAEA,KAAMK,iBAAiB,CACrB,kDADqB,EAErB,gDAFqB,CAAvB;;AAKA,KAAMC,mBAAmB,mBAAzB;;AAGA,KAAMC,gBAAgB,SAAhBA,aAAgB,CAACC,MAAD,EAAY;AAChC,OAAMlB,MAAS,mBAASmB,eAAlB,yBAAN;AACAD,UAAOE,oBAAP,GAA8B,mBAAS/B,IAAT,CAAc+B,oBAA5C;AACA,OAAMC,UAAU;AACdC,aAAQ,MADM;AAEdC,WAAMC,KAAKC,SAAL,CAAeP,MAAf,CAFQ;AAGdQ,cAAS,EAAE,gBAAgB,kBAAlB;AAHK,IAAhB;AAKA;AACA,UAAOC,MAAM3B,GAAN,EAAWqB,OAAX,EAAoB,KAApB,EAA2BO,IAA3B,CAAgC,UAACC,QAAD,EAAc;AACnD,YAAOA,SAAS5B,IAAT,GAAgB2B,IAAhB,CAAqB,UAAC3B,IAAD,EAAU;AACpC,WAAI,CAAC4B,SAASC,EAAd,EAAkB;AAChB,eAAMC,MAAM9B,KAAK+B,KAAX,CAAN,CADgB,CACU;AAC3B;AACD,cAAO/B,KAAKgC,GAAZ;AACD,MALM,CAAP;AAMD,IAPM,CAAP;AAQD,EAjBD;;AAoBA,KAAMC,SAAS,kBAAQC,MAAR,EAAf;;AAGAD,QAAOE,GAAP,CAAW,UAAX,EAAuB,mBAAS,UAAC1C,GAAD,EAAMC,GAAN,EAAc;AAAA,OACpC0C,WADoC,GACpB3C,IAAI4C,KADgB,CACpCD,WADoC;;AAE5C3C,OAAI6C,OAAJ,CAAYF,WAAZ,GAA0BA,WAA1B;;AAEA,OAAMrC,MAAMU,aAAa8B,eAAb,CAA6B;AACvCC,kBAAa,SAD0B;AAEvCC,YAAO3B;AAFgC,IAA7B,CAAZ;;AAKA,UAAOpB,IAAII,QAAJ,CAAaC,GAAb,CAAP;AACD,EAVsB,CAAvB;;AAaAkC,QAAOE,GAAP,CAAW,WAAX,EAAwB,mBAAS,UAAC1C,GAAD,EAAMC,GAAN,EAAc;AAAA,OACrCgD,IADqC,GAC5BjD,IAAI4C,KADwB,CACrCK,IADqC;AAAA,OAErCN,WAFqC,GAErB3C,IAAI6C,OAFiB,CAErCF,WAFqC;;;AAI7C,OAAMO,gBAAgB9B,kBAAkB6B,IAAlB,CAAtB;AACA,OAAME,gBAAgBD,cACjBhB,IADiB,CACZ;AAAA,YAAUtB,WAAWwC,YAAX,CAAwBC,OAAOC,WAA/B,CAAV;AAAA,IADY,EAEjBpB,IAFiB,CAEZ;AAAA,YAAaqB,UAAUP,KAAV,CAAgBQ,KAAhB,CAAsB,GAAtB,CAAb;AAAA,IAFY,CAAtB;AAGA,OAAMC,iBAAiBP,cAClBhB,IADkB,CACb;AAAA,YAAUtB,WAAW8C,UAAX,CAAsBL,OAAOC,WAA7B,CAAV;AAAA,IADa,CAAvB;;AAGA,OAAMK,WAAWC,QAAQC,GAAR,CAAY,CAACX,aAAD,EAAgBC,aAAhB,EAA+BM,cAA/B,CAAZ,CAAjB;;AAEA,OAAMK,aAAaH,SAASzB,IAAT,CAAc,UAAC6B,MAAD,EAAY;AAAA,kCACTA,MADS;AAAA,SACpCV,MADoC;AAAA,SAC5BW,MAD4B;AAAA,SACpBC,OADoB;;AAE3C,SAAMzC,SAAS;AACb0C,iBAAUD,QAAQE,EADL;AAEbC,cAAOH,QAAQI,MAAR,CAAe,CAAf,EAAkBC,KAFZ;AAGbC,aAAMN,QAAQO,WAHD;AAIbR,qBAJa;AAKbX;AALa,MAAf;AAOA,YAAO9B,cAAcC,MAAd,CAAP;AACD,IAVkB,CAAnB;;AAYA,UAAOsC,WAAW5B,IAAX,CAAgB,UAACK,GAAD,EAAS;AAC9BtC,SAAI4C,OAAJ,GAAc,IAAd;AACA5C,SAAIwE,MAAJ,CAAW,KAAX,EAAkBlC,GAAlB;AACAtC,SAAII,QAAJ,CAAa,mBAASqE,eAAT,GAA2B/B,WAAxC;AACD,IAJM,EAIJgC,KAJI,CAIE,UAACrC,KAAD,EAAW;AAClB,SAAIA,MAAMsC,OAAN,KAAkBtD,gBAAtB,EAAwC;AACtC,WAAMuD,kBAAkB7D,aAAa8B,eAAb,CAA6B;AACnDC,sBAAa,SADsC;AAEnD+B,iBAAQ,SAF2C;AAGnD9B,gBAAO3B;AAH4C,QAA7B,CAAxB;AAKApB,WAAII,QAAJ,CAAawE,eAAb;AACD;AACD;AACAnE,aAAQ4B,KAAR,CAAc,oBAAd,EAAoCA,KAApC;AACD,IAfM,CAAP;AAgBD,EAzCuB,CAAxB;;mBA2CeE,M;;;;;;;;;ACzGf,wC;;;;;;;;;;;;;;;;ACAA;;;;AACA;;;;AAGO,KAAMpB,gDAAoB,SAApBA,iBAAoB;AAAA,UAAgB,UAAC6B,IAAD,EAAU;AACzD,YAAO,IAAIW,OAAJ,CAAY,UAACmB,OAAD,EAAUC,MAAV,EAAqB;AACtChE,oBAAaiE,QAAb,CAAsBhC,IAAtB,EAA4B,UAACiC,GAAD,EAAM7B,MAAN,EAAiB;AAC3C,aAAI6B,GAAJ,EAAS;AACPF,kBAAOE,GAAP;AACA;AACD;AACDH,iBAAQ;AACNI,yBAAc9B,OAAO+B,aADf;AAEN9B,wBAAaD,OAAOgC,YAFd;AAGNC,kCAAuBjC,OAAOkC,WAAP,GAAqB,IAHtC,EAAR;AAKD,QAVD;AAWD,MAZM,CAAP;AAaD,IAdgC;AAAA,EAA1B;;AAiBA,KAAMnC,sCAAe,SAAfA,YAAe,CAACE,WAAD,EAAiB;AAC3C,OAAMkC,WAAW,gDAAjB;AACA,OAAMlF,MAASkF,QAAT,sBAAkClC,WAAxC;AACA,UAAO,oBAAUhD,GAAV,CAAP;AACD,EAJM;;AAOA,KAAMoD,kCAAa,SAAbA,UAAa,CAACJ,WAAD,EAAiB;AACzC,OAAIhD,MAAM,8CAAV;AACAA,6BAAwBgD,WAAxB;AACAhD,oBAAe,mBAASX,IAAT,CAAc8F,aAA7B;AACA,UAAO,oBAAUnF,GAAV,CAAP;AACD,EALM,C;;;;;;;;;;;;;;;AC5BP;;;;;;AAEA,oBAASX,IAAT,GAAgBmC,KAAK4D,KAAL,CAAWC,QAAQC,GAAR,CAAYC,SAAvB,CAAhB;;;;;;;;;;;ACFA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,sDAAqD;AACrD;AACA,EAAC;AACD;AACA;AACA;AACA;AACA;AACA,IAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;;;;;;;;;;;;;;;ACvBA;;AAGA;AACA;AACA;AACO,KAAMC,8BAAW,SAAXA,QAAW,CAACC,EAAD,EAAQ;AAC9B,OAAMC,UAAU,SAAVA,OAAU,CAAChG,GAAD,EAAMC,GAAN,EAAc;AAC5B;AACAA,SAAIgG,eAAJ,GAAsB,UAACrB,OAAD,EAAa;AAAG;AACpC,cAAO3E,IAAIiG,MAAJ,CAAW,GAAX,EAAgB3F,IAAhB,CAAqB,EAAE+B,OAAOsC,OAAT,EAArB,CAAP;AACD,MAFD;;AAIA;AACA,SAAMuB,UAAU,IAAIvC,OAAJ,CAAY,UAACmB,OAAD,EAAUC,MAAV,EAAqB;AAC/C,WAAI;AACFD,iBAAQgB,GAAG/F,GAAH,EAAQC,GAAR,CAAR;AACD,QAFD,CAEE,OAAOmG,CAAP,EAAU;AACVpB,gBAAOoB,CAAP;AACD;AACF,MANe,CAAhB;;AAQA;AACAD,aAAQjE,IAAR,CAAa,UAACmE,MAAD,EAAY;AACvB,WAAI,CAACpG,IAAIqG,WAAT,EAAsB;AACpB,aAAI,CAACD,MAAL,EAAa;AACXA,oBAAS,EAAT,CADW,CACG;AACf;AACD,gBAAOpG,IAAIiG,MAAJ,CAAW,GAAX,EAAgB3F,IAAhB,CAAqB8F,MAArB,CAAP;AACD;AACF,MAPD,EAOG1B,KAPH,CAOS,UAACrC,KAAD,EAAW;AAClB;AACA5B,eAAQ4B,KAAR,CAAc,qBAAd,EAAqCA,KAArC;AACA,WAAI,CAACrC,IAAIqG,WAAT,EAAsB;AACpB,gBAAOrG,IAAIiG,MAAJ,CAAW,GAAX,EAAgBK,IAAhB,CAAqB,EAAEjE,OAAO,wBAAT,EAArB,CAAP;AACD;AACF,MAbD;AAcD,IA9BD;;AAgCA,UAAO0D,OAAP;AACD,EAlCM,C,CARP;;AA6CO,KAAMQ,gCAAY,SAAZA,SAAY,CAAClG,GAAD,EAAMqB,OAAN,EAAkB;AACzC,UAAOM,MAAM3B,GAAN,EAAWqB,OAAX,EAAoBO,IAApB,CAAyB,UAACC,QAAD,EAAc;AAC5C,YAAOA,SAAS5B,IAAT,GAAgB2B,IAAhB,CAAqB,UAAC3B,IAAD,EAAU;AACpC,WAAI,CAAC4B,SAASC,EAAd,EAAkB;AAChB,eAAMC,MAAMP,KAAKC,SAAL,CAAexB,IAAf,CAAN,CAAN;AACD;AACD,cAAOA,IAAP;AACD,MALM,CAAP;AAMD,IAPM,CAAP;AAQD,EATM,C;;;;;;;;;AC7CP,8C;;;;;;;;;;;;;;;0pBCAA;;AAEA;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;KAAYK,U;;AACZ;;AAEA;;;;;;;;AAGA,KAAMC,SAAS,qBAAOC,IAAP,CAAYD,MAA3B;;AAGA;;;AAGA,KAAM2B,SAAS,kBAAQC,MAAR,EAAf;;AAGA,KAAMgE,gBAAgB,SAAhBA,aAAgB,CAAClE,GAAD,EAAMmE,QAAN,EAAgBC,YAAhB,EAAiC;AACrD,OAAMnF,SAAS;AACbE,2BAAsB,mBAAS/B,IAAT,CAAc+B,oBADvB;AAEbgF,uBAFa;AAGbC;AAHa,IAAf;AAKA,OAAMhF,UAAU;AACdC,aAAQ,OADM;AAEdC,WAAMC,KAAKC,SAAL,CAAeP,MAAf,CAFQ;AAGdQ,cAAS;AACP,uBAAgB,kBADT;AAEP4E,qCAA4BrE;AAFrB;AAHK,IAAhB;AAQA,OAAMjC,MAAS,mBAASmB,eAAlB,sBAAN;AACA,UAAO,oBAAUnB,GAAV,EAAeqB,OAAf,EAAwBO,IAAxB,CAA6B;AAAA,YAAO,EAAP;AAAA,IAA7B,CAAP;AACD,EAhBD;;AAmBA;;;AAGA,KAAM2E,eAAe,8BAArB;AACA,KAAM7F,eAAe,IAAIH,MAAJ,CACnB,mBAASlB,IAAT,CAAcsB,eADK,EAEnB,mBAAStB,IAAT,CAAcuB,mBAFK,EAGnB,mBAASC,SAAT,GAAqB0F,YAHF,CAArB;AAKA,KAAMzF,oBAAoBR,WAAWQ,iBAAX,CAA6BJ,YAA7B,CAA1B;;AAEAwB,QAAOE,GAAP,CAAW,SAAX,EAAsB,mBAAS,UAAC1C,GAAD,EAAMC,GAAN,EAAc;AAAA,oBACLD,IAAI4C,KADC;AAAA,OACnCD,WADmC,cACnCA,WADmC;AAAA,OACtBgE,YADsB,cACtBA,YADsB;;;AAG3C3G,OAAI6C,OAAJ,CAAYF,WAAZ,GAA0BA,WAA1B;AACA3C,OAAI6C,OAAJ,CAAYN,GAAZ,GAAkBvC,IAAI8G,OAAJ,CAAYvE,GAA9B;AACAvC,OAAI6C,OAAJ,CAAYkE,UAAZ,GAAyB,iBAAOC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CAAzB;;AAEA,OAAMjD,SAASlC,KAAK4D,KAAL,CAAWiB,YAAX,EAAyB3C,MAAxC;;AAEA,OAAM1D,MAAMU,aAAa8B,eAAb,CAA6B;AACvCC,kBAAa,SAD0B;AAEvC+B,aAAQ,SAF+B;AAGvC9B,YAAOgB,MAHgC;AAIvCkD,YAAOlH,IAAI6C,OAAJ,CAAYkE;AAJoB,IAA7B,CAAZ;;AAOA,UAAO9G,IAAII,QAAJ,CAAaC,GAAb,CAAP;AACD,EAjBqB,CAAtB;;AAmBA;AACAkC,QAAOE,GAAP,CAAW,kBAAX,EAA+B,mBAAS,UAAC1C,GAAD,EAAMC,GAAN,EAAc;AAAA,qBACrBD,IAAI4C,KADiB;AAAA,OAC5CK,IAD4C,eAC5CA,IAD4C;AAAA,OACtCX,KADsC,eACtCA,KADsC;AAAA,OAC/B4E,KAD+B,eAC/BA,KAD+B;AAAA,sBAGXlH,IAAI6C,OAHO;AAAA,OAG5CN,GAH4C,gBAG5CA,GAH4C;AAAA,OAGvCI,WAHuC,gBAGvCA,WAHuC;AAAA,OAG1BoE,UAH0B,gBAG1BA,UAH0B;;AAIpD/G,OAAI6C,OAAJ,GAAc,IAAd;;AAEA,OAAM3C,OAAO,SAAPA,IAAO;AAAA,YAAMD,IAAII,QAAJ,CAAa,mBAASqE,eAAT,GAA2B/B,WAAxC,CAAN;AAAA,IAAb;AACA,OAAIL,SAASyE,eAAeG,KAA5B,EAAmC;AACjChH;AACD;;AAED,OAAMgD,gBAAgB9B,kBAAkB6B,IAAlB,CAAtB;AACA,OAAMkE,mBAAmBjE,cACpBhB,IADoB,CACf;AAAA,YAAUtB,WAAWwC,YAAX,CAAwBC,OAAOC,WAA/B,CAAV;AAAA,IADe,CAAzB;AAEA,OAAMK,WAAWC,QAAQC,GAAR,CAAY,CAACX,aAAD,EAAgBiE,gBAAhB,CAAZ,CAAjB;;AAEA,OAAMC,oBAAoBzD,SAASzB,IAAT,CAAc,UAAC6B,MAAD,EAAY;AAAA,kCACtBA,MADsB;AAAA,SAC3CV,MAD2C;AAAA,SACnCE,SADmC;;AAElD,SAAMoD,eAAe;AACnB3C,eAAQT,UAAUP,KAAV,CAAgBQ,KAAhB,CAAsB,GAAtB,CADW;AAEnBF,oBAAaD,OAAOC,WAFD;AAGnB6B,qBAAc9B,OAAO8B,YAHF;AAInBG,8BAAuBjC,OAAOiC;AAJX,MAArB;AAMA,YAAOmB,cAAclE,GAAd,EAAmB,QAAnB,EAA6BoE,YAA7B,CAAP;AACD,IATyB,CAA1B;;AAWA,UAAOS,kBAAkBlF,IAAlB,CAAuBhC,IAAvB,EAA6ByE,KAA7B,CAAmCzE,IAAnC,CAAP;AACD,EA5B8B,CAA/B;;AA+BA;;AAEA,KAAMmH,qBAAwB,mBAASlG,SAAjC,kCAAN;AACAqB,QAAOE,GAAP,CAAW,UAAX,EAAuB,mBAAS,UAAC1C,GAAD,EAAMC,GAAN,EAAc;AAAA,OACpC0C,WADoC,GACpB3C,IAAI4C,KADgB,CACpCD,WADoC;;;AAG5C3C,OAAI6C,OAAJ,CAAYF,WAAZ,GAA0BA,WAA1B;AACA3C,OAAI6C,OAAJ,CAAYN,GAAZ,GAAkBvC,IAAI8G,OAAJ,CAAYvE,GAA9B;AACAvC,OAAI6C,OAAJ,CAAYkE,UAAZ,GAAyB,iBAAOC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CAAzB;;AAEA,OAAMzF,SAAS;AACb8F,gBAAW,mBAAS3H,IAAT,CAAc4H,gBADZ;AAEbC,mBAAcH,kBAFD;AAGbI,oBAAe,MAHF;AAIbP,YAAOlH,IAAI6C,OAAJ,CAAYkE;AAJN,IAAf;AAMA,OAAMW,cAAc,sBAAY3F,SAAZ,CAAsBP,MAAtB,CAApB;AACA,OAAMlB,oDAAkDoH,WAAxD;;AAEA,UAAOzH,IAAII,QAAJ,CAAaC,GAAb,CAAP;AACD,EAjBsB,CAAvB;;AAmBA;AACAkC,QAAOE,GAAP,CAAW,mBAAX,EAAgC,mBAAS,UAAC1C,GAAD,EAAMC,GAAN,EAAc;AAAA,qBACtBD,IAAI4C,KADkB;AAAA,OAC7CK,IAD6C,eAC7CA,IAD6C;AAAA,OACvCiE,KADuC,eACvCA,KADuC;AAAA,OAChC5E,KADgC,eAChCA,KADgC;AAAA,uBAGZtC,IAAI6C,OAHQ;AAAA,OAG7CN,GAH6C,iBAG7CA,GAH6C;AAAA,OAGxCI,WAHwC,iBAGxCA,WAHwC;AAAA,OAG3BoE,UAH2B,iBAG3BA,UAH2B;;AAIrD/G,OAAI6C,OAAJ,GAAc,IAAd;;AAEA,OAAM8E,iBAAiB,mBAASjD,eAAT,GAA2B/B,WAAlD;AACA,OAAIL,SAASyE,eAAeG,KAA5B,EAAmC;AACjCjH,SAAII,QAAJ,CAAasH,cAAb;AACD;;AAGD,OAAMC,eAAe,IAAIhE,OAAJ,CAAY,UAACmB,OAAD,EAAUC,MAAV,EAAqB;AACpD,uBAAQ6C,IAAR,CAAa,wCAAb,EAAuD;AACrDC,aAAM;AACJ7E,mBADI;AAEJ8E,qBAAY,oBAFR;AAGJP,uBAAcH;AAHV,QAD+C;AAMrDvG,aAAM;AACJkH,eAAM,mBAASrI,IAAT,CAAc4H,gBADhB;AAEJU,eAAM,mBAAStI,IAAT,CAAcuI;AAFhB;AAN+C,MAAvD,EAUG,UAACC,QAAD,EAAWhG,QAAX,EAAqBN,IAArB,EAA8B;AAC/B,WAAIsG,QAAJ,EAAc;AACZnD,gBAAOmD,QAAP;AACA;AACD;AACDpD,eAAQjD,KAAK4D,KAAL,CAAW7D,IAAX,CAAR;AACD,MAhBD;AAiBD,IAlBoB,CAArB;;AAoBA,UAAO+F,aACF1F,IADE,CACG,UAACkG,KAAD,EAAW;AACf,SAAMzB,eAAe;AACnBrD,oBAAa8E,MAAM/C,YADA;AAEnBgD,kBAAWD,MAAME;AAFE,MAArB;AAIA,YAAO7B,cAAclE,GAAd,EAAmB,SAAnB,EAA8BoE,YAA9B,CAAP;AACD,IAPE,EAQFzE,IARE,CAQG;AAAA,YAAMjC,IAAII,QAAJ,CAAasH,cAAb,CAAN;AAAA,IARH,EASFhD,KATE,CASI;AAAA,YAAO1E,IAAII,QAAJ,CAAgBsH,cAAhB,eAAwCzC,GAAxC,CAAP;AAAA,IATJ,CAAP;AAUD,EA1C+B,CAAhC;;mBA4Ce1C,M;;;;;;;;;AC7Kf,oC;;;;;;;;;ACAA,0C;;;;;;;;;ACAA,qC","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap a1655faddc1d65623895","import bodyParser from 'body-parser';\nimport express from 'express';\nimport cookieParser from 'cookie-parser';\nimport cookieSession from 'cookie-session';\nimport morgan from 'morgan';\n\nimport auth from './routes/auth';\nimport permissions from './routes/permissions';\n\nimport settings from './settings';\n\n\nconst app = express();\n\napp.use(cookieParser());\napp.use(cookieSession({ secret: settings.keys.scoutWebSessionKey }));\n\nif (!settings.isDev) {\n  app.use(express.static('client/build'));\n}\n\nconst forceHttpsUnlessDev = (req, res, next) => {\n  if (!settings.isDev && settings.isHeroku &&\n      req.header('x-forwarded-proto') !== 'https') {\n    return res.redirect(`https://${req.header('host')}${req.url}`);\n  }\n  return next();\n};\napp.use(forceHttpsUnlessDev);\napp.use(bodyParser.json());\napp.use(morgan('combined'));\n\napp.use('/auth', auth);\napp.use('/permissions', permissions);\n\napp.listen(settings.port, () => {\n  // eslint-disable-next-line no-console\n  console.log('Server listening on: ', settings.port);\n});\n\n\n\n// WEBPACK FOOTER //\n// ./server/index.js","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"express\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"cookie-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cookie-parser\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"cookie-session\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cookie-session\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"morgan\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"morgan\"\n// module id = 5\n// module chunks = 0","import express from 'express';\nimport google from 'googleapis';\n\nimport * as googleAuth from '../infra/google-auth';\nimport { endpoint } from '../infra/net';\nimport settings from '../settings';\n\n\nconst OAuth2 = google.auth.OAuth2;\n\nconst REDIRECT_PATH = '/auth/callback';\nconst oauth2Client = new OAuth2(\n  settings.keys.google_clientId,\n  settings.keys.google_clientSecret,\n  settings.serverUrl + REDIRECT_PATH,\n);\nconst getTokensFromCode = googleAuth.getTokensFromCode(oauth2Client);\n\nconst INITIAL_SCOPES = [\n  'https://www.googleapis.com/auth/userinfo.profile',\n  'https://www.googleapis.com/auth/userinfo.email',\n];\n\nconst NO_REFRESH_TOKEN = 'No refresh token!';\n\n\nconst getJwtPromise = (params) => {\n  const url = `${settings.scoutServiceUrl}/auth/jwt/fromtokens`;\n  params.scoutWebServerSecret = settings.keys.scoutWebServerSecret;\n  const options = {\n    method: 'POST',\n    body: JSON.stringify(params),\n    headers: { 'content-type': 'application/json' },\n  };\n  // Use raw fetch instead of fetchJson to handle the NO_REFRESH_TOKEN case.\n  return fetch(url, options, false).then((response) => {\n    return response.json().then((json) => {\n      if (!response.ok) {\n        throw Error(json.error);  // Might be NO_REFRESH_TOKEN\n      }\n      return json.jwt;\n    });\n  });\n};\n\n\nconst router = express.Router();\n\n\nrouter.get('/sign-in', endpoint((req, res) => {\n  const { destination } = req.query;\n  req.session.destination = destination;\n\n  const url = oauth2Client.generateAuthUrl({\n    access_type: 'offline',\n    scope: INITIAL_SCOPES,\n  });\n\n  return res.redirect(url);\n}));\n\n\nrouter.get('/callback', endpoint((req, res) => {\n  const { code } = req.query;\n  const { destination } = req.session;\n\n  const tokensPromise = getTokensFromCode(code);\n  const scopesPromise = tokensPromise\n      .then(tokens => googleAuth.getTokenInfo(tokens.accessToken))\n      .then(tokenInfo => tokenInfo.scope.split(' '));\n  const profilePromise = tokensPromise\n      .then(tokens => googleAuth.getProfile(tokens.accessToken));\n\n  const promises = Promise.all([tokensPromise, scopesPromise, profilePromise]);\n\n  const jwtPromise = promises.then((values) => {\n    const [tokens, scopes, profile] = values;\n    const params = {\n      googleId: profile.id,\n      email: profile.emails[0].value,\n      name: profile.displayName,\n      scopes,\n      tokens,\n    };\n    return getJwtPromise(params);\n  });\n\n  return jwtPromise.then((jwt) => {\n    res.session = null;\n    res.cookie('jwt', jwt);\n    res.redirect(settings.clientServerUrl + destination);\n  }).catch((error) => {\n    if (error.message === NO_REFRESH_TOKEN) {\n      const forceRefreshUrl = oauth2Client.generateAuthUrl({\n        access_type: 'offline',\n        prompt: 'consent',\n        scope: INITIAL_SCOPES,\n      });\n      res.redirect(forceRefreshUrl);\n    }\n    // eslint-disable-next-line no-console\n    console.error('Error signing in: ', error);\n  });\n}));\n\nexport default router;\n\n\n\n// WEBPACK FOOTER //\n// ./server/routes/auth.js","module.exports = require(\"googleapis\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"googleapis\"\n// module id = 7\n// module chunks = 0","import settings from '../settings';\nimport { fetchJson } from './net';\n\n\nexport const getTokensFromCode = oauth2Client => (code) => {\n  return new Promise((resolve, reject) => {\n    oauth2Client.getToken(code, (err, tokens) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n      resolve({\n        refreshToken: tokens.refresh_token,\n        accessToken: tokens.access_token,\n        accessTokenExpiration: tokens.expiry_date / 1000,  // ms => secs\n      });\n    });\n  });\n};\n\n\nexport const getTokenInfo = (accessToken) => {\n  const INFO_URL = 'https://www.googleapis.com/oauth2/v3/tokeninfo';\n  const url = `${INFO_URL}?access_token=${accessToken}`;\n  return fetchJson(url);\n};\n\n\nexport const getProfile = (accessToken) => {\n  let url = 'https://www.googleapis.com/plus/v1/people/me';\n  url += `?access_token=${accessToken}`;\n  url += `&key=${settings.keys.google_apiKey}`;\n  return fetchJson(url);\n};\n\n\n\n// WEBPACK FOOTER //\n// ./server/infra/google-auth.js","import settings from '../settings';\n\nsettings.keys = JSON.parse(process.env.AUTH_KEYS);\n\nexport default settings;\n\n\n\n// WEBPACK FOOTER //\n// ./server/settings.js","const settings = {};\n\nsettings.isDev = !(process.env.NODE_ENV === 'production' || process.env.NODE_ENV === 'staging');\nsettings.isHeroku = process.env.PORT;\n\nif (settings.isDev) {\n  settings.port = 3001;\n  settings.serverUrl = 'http://localhost:' + settings.port;\n  settings.clientServerUrl = 'http://localhost:3000';  // React's dev server uses different port.\n  settings.scoutServiceUrl = 'http://localhost:5000';\n} else {\n  if (settings.isHeroku) {\n    // Actual prod.\n    settings.port = process.env.PORT;\n    settings.serverUrl = 'https://' + process.env.HOSTNAME;\n    settings.scoutServiceUrl = 'https://scout-service.herokuapp.com';\n  } else {\n    // Compiled prod run locally.\n    settings.port = 3001;\n    settings.serverUrl = 'http://localhost:3001';\n    settings.scoutServiceUrl = 'http://localhost:5000';\n  }\n  settings.clientServerUrl = settings.serverUrl;\n}\n\nmodule.exports = settings;\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./settings.js\n// module id = 10\n// module chunks = 0","// Networking utilities.\n\nimport 'isomorphic-fetch';\n\n\n// A handler wrapper that allows handlers to return promises\n// instead of dealing with req and res. Also, centralizes\n// rejection and error handling and attaches convenience methods.\nexport const endpoint = (fn) => {\n  const wrapper = (req, res) => {\n    // Attach a convenience function to send a JSON client error.\n    res.sendClientError = (message) => {  // eslint-disable-line no-param-reassign\n      return res.status(400).json({ error: message });\n    };\n\n    // Catch errors in the form of a rejected promise.\n    const promise = new Promise((resolve, reject) => {\n      try {\n        resolve(fn(req, res));\n      } catch (e) {\n        reject(e);\n      }\n    });\n\n    // Ensure a response is sent.\n    promise.then((result) => {\n      if (!res.headersSent) {\n        if (!result) {\n          result = {};  // Empty response => success!\n        }\n        return res.status(200).json(result);\n      }\n    }).catch((error) => {\n      // eslint-disable-next-line no-console\n      console.error('Error in handler:\\n', error);\n      if (!res.headersSent) {\n        return res.status(500).send({ error: 'Internal server error.' });\n      }\n    });\n  };\n\n  return wrapper;\n};\n\n\nexport const fetchJson = (url, options) => {\n  return fetch(url, options).then((response) => {\n    return response.json().then((json) => {\n      if (!response.ok) {\n        throw Error(JSON.stringify(json));\n      }\n      return json;\n    });\n  });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./server/infra/net.js","module.exports = require(\"isomorphic-fetch\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"isomorphic-fetch\"\n// module id = 13\n// module chunks = 0","// Permissions for third-party services.\n\n// We do this here instead of in scout-service because we cannot pass JWT to\n\nimport crypto from 'crypto';\nimport express from 'express';\nimport google from 'googleapis';\nimport queryString from 'query-string';\nimport request from 'request';\n\nimport * as googleAuth from '../infra/google-auth';\nimport { endpoint, fetchJson } from '../infra/net';\n\nimport settings from '../../settings';\n\n\nconst OAuth2 = google.auth.OAuth2;\n\n\n// Permissions for third-party services.\n\n\nconst router = express.Router();\n\n\nconst setPermission = (jwt, provider, providerInfo) => {\n  const params = {\n    scoutWebServerSecret: settings.keys.scoutWebServerSecret,\n    provider,\n    providerInfo,\n  };\n  const options = {\n    method: 'PATCH',\n    body: JSON.stringify(params),\n    headers: {\n      'content-type': 'application/json',\n      authorization: `Scout JWT ${jwt}`,\n    },\n  };\n  const url = `${settings.scoutServiceUrl}/api/permissions/`;\n  return fetchJson(url, options).then(() => ({}));\n};\n\n\n// Google permissions.\n\n\nconst redirectPath = '/permissions/callback/google';\nconst oauth2Client = new OAuth2(\n  settings.keys.google_clientId,\n  settings.keys.google_clientSecret,\n  settings.serverUrl + redirectPath,\n);\nconst getTokensFromCode = googleAuth.getTokensFromCode(oauth2Client);\n\nrouter.get('/google', endpoint((req, res) => {\n  const { destination, providerInfo } = req.query;\n\n  req.session.destination = destination;\n  req.session.jwt = req.cookies.jwt;\n  req.session.savedState = crypto.randomBytes(20).toString('hex');\n\n  const scopes = JSON.parse(providerInfo).scopes;\n\n  const url = oauth2Client.generateAuthUrl({\n    access_type: 'offline',\n    prompt: 'consent',\n    scope: scopes,\n    state: req.session.savedState,\n  });\n\n  return res.redirect(url);\n}));\n\n// Note: Does NOT require an auth header.\nrouter.get('/callback/google', endpoint((req, res) => {\n  const { code, error, state } = req.query;\n\n  const { jwt, destination, savedState } = req.session;\n  req.session = null;\n\n  const next = () => res.redirect(settings.clientServerUrl + destination);\n  if (error || savedState !== state) {\n    next();\n  }\n\n  const tokensPromise = getTokensFromCode(code);\n  const tokenInfoPromise = tokensPromise\n      .then(tokens => googleAuth.getTokenInfo(tokens.accessToken));\n  const promises = Promise.all([tokensPromise, tokenInfoPromise]);\n\n  const permissionPromise = promises.then((values) => {\n    const [tokens, tokenInfo] = values;\n    const providerInfo = {\n      scopes: tokenInfo.scope.split(' '),\n      accessToken: tokens.accessToken,\n      refreshToken: tokens.refreshToken,\n      accessTokenExpiration: tokens.accessTokenExpiration,\n    };\n    return setPermission(jwt, 'google', providerInfo);\n  });\n\n  return permissionPromise.then(next).catch(next);\n}));\n\n\n// Dropbox permissions.\n\nconst dropboxRedirectUri = `${settings.serverUrl}/permissions/callback/dropbox`;\nrouter.get('/dropbox', endpoint((req, res) => {\n  const { destination } = req.query;\n\n  req.session.destination = destination;\n  req.session.jwt = req.cookies.jwt;\n  req.session.savedState = crypto.randomBytes(20).toString('hex');\n\n  const params = {\n    client_id: settings.keys.dropbox_clientId,\n    redirect_uri: dropboxRedirectUri,\n    response_type: 'code',\n    state: req.session.savedState,\n  };\n  const stringified = queryString.stringify(params);\n  const url = `https://www.dropbox.com/oauth2/authorize?${stringified}`;\n\n  return res.redirect(url);\n}));\n\n// Note: Does NOT require an auth header.\nrouter.get('/callback/dropbox', endpoint((req, res) => {\n  const { code, state, error } = req.query;\n\n  const { jwt, destination, savedState } = req.session;\n  req.session = null;\n\n  const destinationUrl = settings.clientServerUrl + destination;\n  if (error || savedState !== state) {\n    res.redirect(destinationUrl);\n  }\n\n\n  const tokenPromise = new Promise((resolve, reject) => {\n    request.post('https://api.dropbox.com/1/oauth2/token', {\n      form: {\n        code,\n        grant_type: 'authorization_code',\n        redirect_uri: dropboxRedirectUri,\n      },\n      auth: {\n        user: settings.keys.dropbox_clientId,\n        pass: settings.keys.dropbox_clientSecret,\n      },\n    }, (reqError, response, body) => {\n      if (reqError) {\n        reject(reqError);\n        return;\n      }\n      resolve(JSON.parse(body));\n    });\n  });\n\n  return tokenPromise\n      .then((token) => {\n        const providerInfo = {\n          accessToken: token.access_token,\n          accountId: token.account_id,\n        };\n        return setPermission(jwt, 'dropbox', providerInfo);\n      })\n      .then(() => res.redirect(destinationUrl))\n      .catch(err => res.redirect(`${destinationUrl}?error=${err}`));\n}));\n\nexport default router;\n\n\n\n// WEBPACK FOOTER //\n// ./server/routes/permissions.js","module.exports = require(\"crypto\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"crypto\"\n// module id = 15\n// module chunks = 0","module.exports = require(\"query-string\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"query-string\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"request\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"request\"\n// module id = 17\n// module chunks = 0"],"sourceRoot":""}